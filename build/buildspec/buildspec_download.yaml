# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
# SPDX-License-Identifier: Apache-2.0

version: 0.2

env:
  shell: bash

phases:
  pre_build:
    commands:
      - echo Build started on `date`
      - echo Installing Mountpoint for Amazon S3
      - wget https://s3.amazonaws.com/mountpoint-s3-release/latest/x86_64/mount-s3.deb
      - sudo apt-get install -y ./mount-s3.deb
      - echo Mounting 
      - mkdir /s3
      - >
        if [[ "$DESTINATION_URI" =~ ^s3?://([^/]+) ]]; then
          BUCKET_NAME=${BASH_REMATCH[1]}
          echo "Bucket name: $BUCKET_NAME"
        else
          echo "Invalid S3 URI"
        fi
      - mount-s3 $BUCKET_NAME /s3
      - >
        if [[ "$DESTINATION_URI" =~ ^s3?://[^/]+(/.*)/ ]]; then
          KEY=${BASH_REMATCH[1]}
          echo "Key name: $KEY"
        else
          KEY=""
        fi
  build:
    commands:
      - FILENAME=$(basename $SOURCE_URI)
      - echo Downloading $SOURCE_URI
      - wget $SOURCE_URI -P /s3$KEY --no-verbose
      - echo Build completed on `date`
      
  post_build:
    commands:
      - echo Build completed on `date`
